


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ru-RU" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ru-RU" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating Custom Programs for Qiskit Runtime &mdash; документация Qiskit Runtime IBM Client 0.6.0</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Алфавитный указатель" href="../../genindex.html" />
    <link rel="search" title="Поиск" href="../../search.html" />
    <link rel="next" title="Custom Expectation Value Program for the Qiskit Runtime" href="../sample_expval_program/qiskit_runtime_expval_program.html" />
    <link rel="prev" title="Uploading a Qiskit runtime program" href="../05_uploading_program.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://qiskit.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="../../getting_started.html">Getting started</a>
          </li>

          <li>
            <a href="../../tutorials.html">Tutorials</a>
          </li>

          <li>
            <a href="https://qiskit.org/documentation/partners/" target="_blank">Qiskit Providers</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Applications
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/machine-learning/">
                  <span class="dropdown-title">Machine learning</span>
                  <p>QSVM, VQC (Variational Quantum Classifier), and QGAN (Quantum Generative
                    Adversarial Network) algorithms.</p>
                </a>
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/nature/">
                  <span class="dropdown-title">Nature</span>
                  <p>Quantum applications in chemistry, physics, and biology.</p>
                </a>
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/finance/">
                  <span class="dropdown-title">Finance</span>
                  <p>Uncertainty components for stock/securities problems, Ising translators for
                    portfolio optimizations and data providers to source real or random data.</p>
                </a>
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/optimization/">
                  <span class="dropdown-title">Optimization</span>
                  <p>High-level optimization problems that are ready to
                    run on simulators and real quantum devices</p>
                </a>
              </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://qiskit.slack.com">
                  <span class="dropdown-title">Slack support</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://qiskit.org/textbook">
                  <span class="dropdown-title">Qiskit Textbook</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://qiskit.org/events">
                  <span class="dropdown-title">Qiskit events</span>
                  <p></p>
                </a>
            </div>
          </li>
          <li>
            <a href="https://github.com/Qiskit/qiskit-ibm-runtime" target="_blank">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="rst-current-version-label">ru_RU</span>
    <span class="rst-versions-dropdown-icon"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>Languages</dt>
      
        <dd><a class="version" href="/documentation/partners/qiskit_ibm_runtime/tutorials/sample_vqe_program/qiskit_runtime_vqe_program.html">English</a></dd>
      
    </dl>
    
  </div>
  <script>
    jQuery('.version').click((evt) => {
      const hash = window.location.hash
      const complete_url = evt.target.href + hash
      window.location = complete_url
      evt.preventDefault()
    })
  </script>
</div>

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to.html">How to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidocs/ibm-runtime.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Qiskit/qiskit-ibm-runtime">GitHub</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../tutorials.html">Tutorials</a> &gt;</li>
        
      <li>Creating Custom Programs for Qiskit Runtime</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../../_sources/tutorials/sample_vqe_program/qiskit_runtime_vqe_program.ipynb" rel="nofollow"><img src="../../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">
          
          <div class="rst-content style-external-links">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>This page was generated from <a class="reference external" href="https://github.com/Qiskit/qiskit-ibm-runtime/blob/stable/0.6/docs/tutorials/sample_vqe_program/qiskit_runtime_vqe_program.ipynb">docs/tutorials/sample_vqe_program/qiskit_runtime_vqe_program.ipynb</a>.</p>
</div>
<section id="Creating-Custom-Programs-for-Qiskit-Runtime">
<h1>Creating Custom Programs for Qiskit Runtime<a class="headerlink" href="#Creating-Custom-Programs-for-Qiskit-Runtime" title="Permalink to this heading">¶</a></h1>
<p><p>Paul Nation</p>
</p><p><p>IBM Quantum Partners Technical Enablement Team</p>
</p><p>Here we will demonstrate how to create, upload, and use a custom Program for Qiskit Runtime. As the utility of the Runtime execution engine lies in its ability to execute many quantum circuits with low latencies, this tutorial will show how to create your own Variational Quantum Eigensolver (VQE) program from scratch.</p>
<section id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>You must have the latest Qiskit installed.</p></li>
<li><p>You must have either an IBM Cloud or an IBM Quantum account that can access Qiskit Runtime.</p></li>
</ul>
</section>
<section id="Current-limitations">
<h2>Current limitations<a class="headerlink" href="#Current-limitations" title="Permalink to this heading">¶</a></h2>
<p>The runtime execution engine currently has the following limitations that must be kept in mind:</p>
<ul class="simple">
<li><p>The Docker images used by the runtime include only Qiskit and its dependencies, with few exceptions. One exception is the inclusion of the <code class="docutils literal notranslate"><span class="pre">mthree</span></code> measurement mitigation package.</p></li>
<li><p>For security reasons, the runtime cannot make internet calls outside of the environment.</p></li>
</ul>
<p>As Qiskit Runtime matures, these limitations will be removed.</p>
</section>
<section id="Simple-VQE">
<h2>Simple VQE<a class="headerlink" href="#Simple-VQE" title="Permalink to this heading">¶</a></h2>
<p>VQE is an hybrid quantum-classical optimization procedure that finds the lowest eigenstate and eigenenergy of a linear system defined by a given Hamiltonian of Pauli operators. For example, consider the following two-qubit Hamiltonian:</p>
<div class="math notranslate nohighlight">
\[H = A X_{1}\otimes X_{0} + A Y_{1}\otimes Y_{0} + A Z_{1}\otimes Z_{0},\]</div>
<p>where <span class="math notranslate nohighlight">\(A\)</span> is numerical coefficient and the subscripts label the qubits on which the operators act. The zero index being farthest right is the ordering used in Qiskit. The Pauli operators tell us which measurement basis to to use when measuring each of the qubits.</p>
<p>We want to find the ground state (lowest energy state) of this Hamiltonian, and the associated eigenvector. To do this we must start at a given initial state and iteratively vary the parameters that define this state using a classical optimizer, such that the computed energies of subsequent steps are nominally lower than those previously. The parameterized state of the system is defined by an ansatz quantum circuit that should have non-zero support in the direction of the ground state. Because
in general we do not know the solution, the choice of ansatz circuit can be highly problem-specific with a form dictated by additional information. For further information about variational algorithms, we point the reader to <a class="reference external" href="https://doi.org/10.1038/s42254-021-00348-9">Nature Reviews Physics volume 3, 625 (2021)</a>.</p>
<p>Thus we need at least the following inputs to create our VQE quantum program:</p>
<ol class="arabic simple">
<li><p>A representation of the Hamiltonian that specifies the problem.</p></li>
<li><p>A choice of parameterized ansatz circuit, and the ability to pass configuration options, if any.</p></li>
</ol>
<p>However, the following are also beneficial inputs that users might want to have:</p>
<ol class="arabic simple" start="3">
<li><p>Add the ability to pass an initial state.</p></li>
<li><p>Vary the number of shots that are taken.</p></li>
<li><p>Ability to select which classical optimizer is used, and set configuraton values, if any.</p></li>
<li><p>Ability to turn on and off measurement mitigation.</p></li>
</ol>
</section>
<section id="Specifying-the-form-of-the-input-values">
<h2>Specifying the form of the input values<a class="headerlink" href="#Specifying-the-form-of-the-input-values" title="Permalink to this heading">¶</a></h2>
<p>All inputs to runtime programs must be serializable objects. That is to say, whatever you pass into a runtime program must be able to be converted to JSON format. It is thus beneficial to keep inputs limited to basic data types and structures unless you have experience with custom object serialization, or they are common Qiskit types such as <code class="docutils literal notranslate"><span class="pre">QuantumCircuit</span></code> etc that the built-in <code class="docutils literal notranslate"><span class="pre">RuntimeEncoder</span></code> can handle. Fortunately, the VQE program described above can be made out of simple Python
components.</p>
<p>First, it is possible to represent any Hamiltonian using a list of values with each containing the numerical coefficeint for each term and the string representation for the Pauli operators. For the above example, the ground state energy with <span class="math notranslate nohighlight">\(A=1\)</span> is <span class="math notranslate nohighlight">\(-3\)</span> and we can write it as:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">H</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;XX&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;YY&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ZZ&quot;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<p>Next we have to provide the ability to specify the parameterized Ansatz circuit. Here we will take advange of the fact that many ansatz circuits are pre-defined in the Qiskit Circuit Library. Examples can be found in the <a class="reference external" href="https://qiskit.org/documentation/apidoc/circuit_library.html#n-local-circuits">N-local circuits section</a>.</p>
<p>We would like the user to be able to select between ansatz options such as: <code class="docutils literal notranslate"><span class="pre">NLocal</span></code>, <code class="docutils literal notranslate"><span class="pre">TwoLocal</span></code>, and <code class="docutils literal notranslate"><span class="pre">EfficientSU2</span></code>. We could have the user pass the whole ansatz circuit to the program; however, in order to reduce the size of the upload we will pass the ansatz by name. In the runtime program, we can take this name and get the class that it corresponds to from the library using, for example,</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">qiskit.circuit.library.n_local</span> <span class="k">as</span> <span class="nn">lib_local</span>

<span class="n">ansatz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lib_local</span><span class="p">,</span> <span class="s2">&quot;EfficientSU2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For the ansatz configuration, we will pass a simple <code class="docutils literal notranslate"><span class="pre">dict</span></code> of values.</p>
<section id="Optionals">
<h3>Optionals<a class="headerlink" href="#Optionals" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>If we want to add the ability to pass an initial state, then we will need to add the ability to pass a 1D list/ NumPy array. Because the number of parameters depends on the ansatz and its configuration, the user would have to know what ansatz they are doing ahead of time.</p></li>
<li><p>Selecting a number of shots requires simply passing an integer value.</p></li>
<li><p>Here we will allow selecting a classical optimizer by name from those in SciPy, and a <code class="docutils literal notranslate"><span class="pre">dict</span></code> of configuration parameters. Note that for execution on an actual system, the noise inherent in today’s quantum systems makes having a stochastic optimizer crucial to success. SciPy does not have such a choice, and the one built into Qiskit is wrapped in such a manner as to make it difficult to use elsewhere. As such, here we will use an SPSA optimizer written to match the style of those in SciPy.
This function is given in <a class="reference external" href="#Appendix-A">Appendix A</a>.</p></li>
</ul>
<ul class="simple">
<li><p>Finally, for measurement error mitigation we can simply pass a boolean (True/False) value.</p></li>
</ul>
</section>
</section>
<section id="Main-program">
<h2>Main program<a class="headerlink" href="#Main-program" title="Permalink to this heading">¶</a></h2>
<p>We are now in a position to start building our main program. However, before doing so we point out that it makes the code cleaner to make a separate fuction that takes strings of Pauli operators that define our Hamiltonian and convert them to a list of circuits with single-qubit gates that change the measurement basis for each qubit, if needed. This function is given in <a class="reference external" href="#Appendix-B">Appendix B</a>.</p>
<section id="Required-signature">
<h3>Required signature<a class="headerlink" href="#Required-signature" title="Permalink to this heading">¶</a></h3>
<p>Every runtime program is defined via the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, and must have the following input signature:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>main(backend, user_message, *args, **kwargs)
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">backend</span></code> is the backend that the program is to be executed on, and <code class="docutils literal notranslate"><span class="pre">user_message</span></code> is the class by which interim (and possibly final) results are communicated back to the user. After these two items, we add our program-specific arguments and keyword arguments.</p>
</section>
<section id="The-main-VQE-program">
<h3>The main VQE program<a class="headerlink" href="#The-main-VQE-program" title="Permalink to this heading">¶</a></h3>
<p>Here is the main program for our sample VQE. What each element of the function does is written in the comments before the element appears.</p>
<p>This program uses the <code class="docutils literal notranslate"><span class="pre">mthree</span></code> measurement mitigation package. You can install the package via <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">mthree</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grab functions and modules from dependencies</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>
<span class="kn">import</span> <span class="nn">mthree</span>

<span class="c1"># Grab functions and modules from Qiskit needed</span>
<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">transpile</span>
<span class="kn">import</span> <span class="nn">qiskit.circuit.library.n_local</span> <span class="k">as</span> <span class="nn">lib_local</span>

<span class="c1"># The entrypoint for our Runtime Program</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">backend</span><span class="p">,</span>
    <span class="n">user_messenger</span><span class="p">,</span>
    <span class="n">hamiltonian</span><span class="p">,</span>
    <span class="n">ansatz</span><span class="o">=</span><span class="s2">&quot;EfficientSU2&quot;</span><span class="p">,</span>
    <span class="n">ansatz_config</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;SPSA&quot;</span><span class="p">,</span>
    <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
    <span class="n">shots</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
    <span class="n">use_measurement_mitigation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main sample VQE program.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        backend (ProgramBackend): Qiskit backend instance.</span>
<span class="sd">        user_messenger (UserMessenger): Used to communicate with the</span>
<span class="sd">                                        program user.</span>
<span class="sd">        hamiltonian (list): Hamiltonian whose ground state we want to find.</span>
<span class="sd">        ansatz (str): Optional, name of ansatz quantum circuit to use,</span>
<span class="sd">                      default=&#39;EfficientSU2&#39;</span>
<span class="sd">        ansatz_config (dict): Optional, configuration parameters for the</span>
<span class="sd">                              ansatz circuit.</span>
<span class="sd">        x0 (array_like): Optional, initial vector of parameters.</span>
<span class="sd">        optimizer (str): Optional, string specifying classical optimizer,</span>
<span class="sd">                         default=&#39;SPSA&#39;.</span>
<span class="sd">        optimizer_config (dict): Optional, configuration parameters for the</span>
<span class="sd">                                 optimizer.</span>
<span class="sd">        shots (int): Optional, number of shots to take per circuit.</span>
<span class="sd">        use_measurement_mitigation (bool): Optional, use measurement mitigation,</span>
<span class="sd">                                           default=False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        OptimizeResult: The result in SciPy optimization format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Split the Hamiltonian into two arrays, one for coefficients, the other for</span>
    <span class="c1"># operator strings</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hamiltonian</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">op_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hamiltonian</span><span class="p">]</span>
    <span class="c1"># The number of qubits needed is given by the number of elements in the strings</span>
    <span class="c1"># the defiune the Hamiltonian. Here we grab this data from the first element.</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># We grab the requested ansatz circuit class from the Qiskit circuit library</span>
    <span class="c1"># n_local module and configure it using the number of qubits and options</span>
    <span class="c1"># passed in the ansatz_config.</span>
    <span class="n">ansatz_instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lib_local</span><span class="p">,</span> <span class="n">ansatz</span><span class="p">)</span>
    <span class="n">ansatz_circuit</span> <span class="o">=</span> <span class="n">ansatz_instance</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="o">**</span><span class="n">ansatz_config</span><span class="p">)</span>

    <span class="c1"># Here we use our convenence function from Appendix B to get measurement circuits</span>
    <span class="c1"># with the correct single-qubit rotation gates.</span>
    <span class="n">meas_circs</span> <span class="o">=</span> <span class="n">opstr_to_meas_circ</span><span class="p">(</span><span class="n">op_strings</span><span class="p">)</span>

    <span class="c1"># When computing the expectation value for the energy, we need to know if we</span>
    <span class="c1"># evaluate a Z measurement or and identity measurement.  Here we take and X and Y</span>
    <span class="c1"># operator in the strings and convert it to a Z since we added the rotations</span>
    <span class="c1"># with the meas_circs.</span>
    <span class="n">meas_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">op_strings</span><span class="p">]</span>

    <span class="c1"># Take the ansatz circuits, add the single-qubit measurement basis rotations from</span>
    <span class="c1"># meas_circs, and finally append the measurements themselves.</span>
    <span class="n">full_circs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ansatz_circuit</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">mcirc</span><span class="p">)</span><span class="o">.</span><span class="n">measure_all</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">mcirc</span> <span class="ow">in</span> <span class="n">meas_circs</span>
    <span class="p">]</span>

    <span class="c1"># Get the number of parameters in the ansatz circuit.</span>
    <span class="n">num_params</span> <span class="o">=</span> <span class="n">ansatz_circuit</span><span class="o">.</span><span class="n">num_parameters</span>

    <span class="c1"># Use a given initial state, if any, or do random initial state.</span>
    <span class="k">if</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Number of params in x0 (</span><span class="si">{}</span><span class="s2">) does not match number </span><span class="se">\</span>
<span class="s2">                              of ansatz parameters (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_params</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_params</span><span class="p">)</span>

    <span class="c1"># Because we are in general targeting a real quantum system, our circuits must be transpiled</span>
    <span class="c1"># to match the system topology and, hopefully, optimize them.</span>
    <span class="c1"># Here we will set the transpiler to the most optimal settings where &#39;sabre&#39; layout and</span>
    <span class="c1"># routing are used, along with full O3 optimization.</span>

    <span class="c1"># This works around a bug in Qiskit where Sabre routing fails for simulators (Issue #7098)</span>
    <span class="n">trans_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">backend</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">simulator</span><span class="p">:</span>
        <span class="n">trans_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;layout_method&quot;</span><span class="p">:</span> <span class="s2">&quot;sabre&quot;</span><span class="p">,</span> <span class="s2">&quot;routing_method&quot;</span><span class="p">:</span> <span class="s2">&quot;sabre&quot;</span><span class="p">}</span>
    <span class="n">trans_circs</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">full_circs</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">optimization_level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">trans_dict</span><span class="p">)</span>

    <span class="c1"># If using measurement mitigation we need to find out which physical qubits our transpiled</span>
    <span class="c1"># circuits actually measure, construct a mitigation object targeting our backend, and</span>
    <span class="c1"># finally calibrate our mitgation by running calibration circuits on the backend.</span>
    <span class="k">if</span> <span class="n">use_measurement_mitigation</span><span class="p">:</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="n">mthree</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">final_measurement_mapping</span><span class="p">(</span><span class="n">trans_circs</span><span class="p">)</span>
        <span class="n">mit</span> <span class="o">=</span> <span class="n">mthree</span><span class="o">.</span><span class="n">M3Mitigation</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">mit</span><span class="o">.</span><span class="n">cals_from_system</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>

    <span class="c1"># Here we define a callback function that will stream the optimizer parameter vector</span>
    <span class="c1"># back to the user after each iteration.  This uses the `user_messenger` object.</span>
    <span class="c1"># Here we convert to a list so that the return is user readable locally, but</span>
    <span class="c1"># this is not required.</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">xk</span><span class="p">):</span>
        <span class="n">user_messenger</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">xk</span><span class="p">))</span>

    <span class="c1"># This is the primary VQE function executed by the optimizer. This function takes the</span>
    <span class="c1"># parameter vector as input and returns the energy evaluated using an ansatz circuit</span>
    <span class="c1"># bound with those parameters.</span>
    <span class="k">def</span> <span class="nf">vqe_func</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="c1"># Attach (bind) parameters in params vector to the transpiled circuits.</span>
        <span class="n">bound_circs</span> <span class="o">=</span> <span class="p">[</span><span class="n">circ</span><span class="o">.</span><span class="n">bind_parameters</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">for</span> <span class="n">circ</span> <span class="ow">in</span> <span class="n">trans_circs</span><span class="p">]</span>

        <span class="c1"># Submit the job and get the resultant counts back</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">bound_circs</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>

        <span class="c1"># If using measurement mitigation apply the correction and</span>
        <span class="c1"># compute expectation values from the resultant quasiprobabilities</span>
        <span class="c1"># using the measurement strings.</span>
        <span class="k">if</span> <span class="n">use_measurement_mitigation</span><span class="p">:</span>
            <span class="n">quasi_collection</span> <span class="o">=</span> <span class="n">mit</span><span class="o">.</span><span class="n">apply_correction</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">maps</span><span class="p">)</span>
            <span class="n">expvals</span> <span class="o">=</span> <span class="n">quasi_collection</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">meas_strings</span><span class="p">)</span>
        <span class="c1"># If not doing any mitigation just compute expectation values</span>
        <span class="c1"># from the raw counts using the measurement strings.</span>
        <span class="c1"># Since Qiskit does not have such functionality we use the convenence</span>
        <span class="c1"># function from the mthree mitigation module.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expvals</span> <span class="o">=</span> <span class="n">mthree</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">meas_strings</span><span class="p">)</span>

        <span class="c1"># The energy is computed by simply taking the product of the coefficients</span>
        <span class="c1"># and the computed expectation values and summing them. Here we also</span>
        <span class="c1"># take just the real part as the coefficients can possibly be complex,</span>
        <span class="c1"># but the energy (eigenvalue) of a Hamiltonian is always real.</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeffs</span> <span class="o">*</span> <span class="n">expvals</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">energy</span>

    <span class="c1"># Here is where we actually perform the computation.  We begin by seeing what</span>
    <span class="c1"># optimization routine the user has requested, eg. SPSA verses SciPy ones,</span>
    <span class="c1"># and dispatch to the correct optimizer.  The selected optimizer starts at</span>
    <span class="c1"># x0 and calls &#39;vqe_func&#39; everytime the optimizer needs to evaluate the cost</span>
    <span class="c1"># function.  The result is returned as a SciPy OptimizerResult object.</span>
    <span class="c1"># Additionally, after every iteration, we use the &#39;callback&#39; function to</span>
    <span class="c1"># publish the interim results back to the user. This is important to do</span>
    <span class="c1"># so that if the Program terminates unexpectedly, the user can start where they</span>
    <span class="c1"># left off.</span>

    <span class="c1"># Since SPSA is not in SciPy need if statement</span>
    <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s2">&quot;SPSA&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fmin_spsa</span><span class="p">(</span><span class="n">vqe_func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">optimizer_config</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
    <span class="c1"># All other SciPy optimizers here</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
            <span class="n">vqe_func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">optimizer_config</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span>
        <span class="p">)</span>
    <span class="c1"># Return result. OptimizeResult is a subclass of dict.</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Local-testing">
<h2>Local testing<a class="headerlink" href="#Local-testing" title="Permalink to this heading">¶</a></h2>
<div class="alert alert-block alert-info"><p>Important: You need to execute the code blocks in Appendices A and B before continuing.</p>
</div><p>We can test whether our routine works by simply calling the <code class="docutils literal notranslate"><span class="pre">main</span></code> function with a backend instance, a <code class="docutils literal notranslate"><span class="pre">UserMessenger</span></code>, and sample arguments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit_ibm_runtime.program</span> <span class="kn">import</span> <span class="n">UserMessenger</span>

<span class="n">msg</span> <span class="o">=</span> <span class="n">UserMessenger</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the local Aer simulator</span>
<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">Aer</span>

<span class="n">backend</span> <span class="o">=</span> <span class="n">Aer</span><span class="o">.</span><span class="n">backend</span><span class="p">(</span><span class="s2">&quot;qasm_simulator&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute the main routine for our simple two-qubit Hamiltonian H, and perform 5 iterations of the SPSA solver.</span>
<span class="n">main</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2.5999598313051693, 2.0022895184595497, 4.1443691045470725, 1.8766140406393257, 0.9651373061302296, -0.506671485310807, 0.9101090756597013, -0.2828877478731248, 3.320525264153237, 3.3748302795485885, 3.32638811773525, 4.209570379303731, 2.7300154722181795, 6.467708832870941, 0.18091944802832982, 3.148148576085024]
[2.5952007153266448, 2.0070486344380742, 4.149128220525597, 1.8718549246608014, 0.9603781901517052, -0.5019123693322826, 0.9053499596811769, -0.2876468638516492, 3.3157661481747125, 3.370071163570064, 3.3216290017567256, 4.204811263325206, 2.734774588196704, 6.472467948849466, 0.1761603320498054, 3.1433894601064996]
[2.3777276911399334, 2.2245216586247856, 3.9316551963388857, 1.65438190047409, 0.7429051659649939, -0.719385393518994, 0.6878769354944656, -0.07017383966493784, 3.533239172361424, 3.1525981393833526, 3.539102025943437, 4.422284287511918, 2.9522476123834154, 6.689940973036177, 0.3936333562365168, 2.9259164359197882]
[2.977308422656524, 2.824102390141376, 3.3320744648222953, 2.2539626319906807, 0.14332443444840337, -0.11980466200240347, 0.08829620397787508, -0.6697545711815284, 4.132819903878015, 2.5530174078667622, 2.9395212944268465, 5.021865019028509, 3.551828343900006, 6.090360241519586, -0.20594737528007373, 3.5254971674363786]
[3.203990035001531, 2.5974207777963687, 3.5587560771673026, 2.0272810196456734, 0.37000604679341076, -0.34648627434741086, 0.31497781632288246, -0.8964361835265358, 4.359501516223022, 2.326335795521755, 2.7128396820818392, 5.248546631373516, 3.3251467315549985, 6.317041853864594, 0.02073423706493363, 3.2988155550913714]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     fun: -2.513916015625
 message: &#39;Optimization terminated successfully.&#39;
    nfev: 10
     nit: 5
 success: True
       x: array([ 3.20399004,  2.59742078,  3.55875608,  2.02728102,  0.37000605,
       -0.34648627,  0.31497782, -0.89643618,  4.35950152,  2.3263358 ,
        2.71283968,  5.24854663,  3.32514673,  6.31704185,  0.02073424,
        3.29881556])
</pre></div></div>
</div>
<p>Having executed the above, we see that there are 5 parameter arrays returned, one for each callback, along with the final optimization result. The parameter arrays are the interim results, and the <code class="docutils literal notranslate"><span class="pre">UserMessenger</span></code> object prints these values to the cell output. The output itself is the answer we obtained, expressed as a SciPy <code class="docutils literal notranslate"><span class="pre">OptimizerResult</span></code> object.</p>
</section>
<section id="Program-metadata">
<h2>Program metadata<a class="headerlink" href="#Program-metadata" title="Permalink to this heading">¶</a></h2>
<p>Program metadata is essentially the docstring for a runtime program. It describes overall program information such as the program <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">description</span></code>, and the <code class="docutils literal notranslate"><span class="pre">max_execution_time</span></code> the program is allowed to run, as well as details the inputs and the outputs the program expects. At a bare minimum the values described above are required</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sample-vqe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A sample VQE program.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;max_execution_time&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>It is important to set the <code class="docutils literal notranslate"><span class="pre">max_execution_time</span></code> high enough so that your program does not get terminated unexpectedly. Additionally, one should make sure that interim results are sent back to the user so that, if something does happen, the user can start where they left off.</p>
<p>It is, however, good form to detail the parameters and return types, as well as interim results. That being said, if making a runtime intended to be used by others, this information would also likely be mirrored in the signature of a function or class that the user would interact with directly; end users should not directly call runtime programs. We will see why below. Nevertheless, let us add to our metadata. First, the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> section details the inputs the user is able to pass:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;https://json-schema.org/draft/2019-09/schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;hamiltonian&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Hamiltonian whose ground state we want to find.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;ansatz&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of ansatz quantum circuit to use, default=&#39;EfficientSU2&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;EfficientSU2&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;ansatz_config&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Configuration parameters for the ansatz circuit.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Classical optimizer to use, default=&#39;SPSA&#39;.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;SPSA&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Initial vector of parameters. This is a numpy array.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;optimizer_config&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Configuration parameters for the optimizer.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;shots&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of shots used for each circuit evaluation.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;use_measurement_mitigation&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Use measurement mitigation, default=False.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hamiltonian&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Next, the <code class="docutils literal notranslate"><span class="pre">return_values</span></code> section tells about the return types:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;return_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;https://json-schema.org/draft/2019-09/schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Final result in SciPy optimizer format&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>and finally let us specify what comes back when an interim result is returned:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;interim_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;https://json-schema.org/draft/2019-09/schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Parameter vector at current optimization step. This is a numpy array.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Uploading-the-program">
<h2>Uploading the program<a class="headerlink" href="#Uploading-the-program" title="Permalink to this heading">¶</a></h2>
<p>We now have all the ingredients needed to upload our program. To do so we need to collect all of our code in one file, here called <code class="docutils literal notranslate"><span class="pre">sample_vqe.py</span></code> for uploading. This limitation will be removed in later versions of Qiskit Runtime. Alternatively, if the entire code is contained within a single Jupyter notebook cell, this can be done using the magic function</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%%writefile my_program.py
</pre></div>
</div>
<p>To actually upload the program we need to initialize a Qiskit Runtime service:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit_ibm_runtime</span> <span class="kn">import</span> <span class="n">QiskitRuntimeService</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">QiskitRuntimeService</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Program-upload">
<h3>Program upload<a class="headerlink" href="#Program-upload" title="Permalink to this heading">¶</a></h3>
<p>The call to <code class="docutils literal notranslate"><span class="pre">program_upload</span></code> takes the target Python file as <code class="docutils literal notranslate"><span class="pre">data</span></code> and the metadata as inputs.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">program_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_program</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;sample_vqe.py&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
<span class="n">program_id</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;sample-vqe-E3DO04qqoQ&#39;
</pre></div></div>
</div>
<p>Here the <code class="docutils literal notranslate"><span class="pre">upload_program()</span></code> method returns a <code class="docutils literal notranslate"><span class="pre">program_id</span></code>, which is how you should reference your program.</p>
</section>
<section id="Program-information">
<h3>Program information<a class="headerlink" href="#Program-information" title="Permalink to this heading">¶</a></h3>
<p>We can query the program for information and see that our metadata is correctly being attached:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prog</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">program</span><span class="p">(</span><span class="n">program_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sample-vqe-E3DO04qqoQ:
  Name: sample-vqe
  Description: A sample VQE program.
  Creation date: 2022-01-12T16:04:15.806869Z
  Update date: 2022-01-12T16:04:15.806869Z
  Max execution time: 100000
  Input parameters:
    Properties:
        - ansatz:
            Default: EfficientSU2
            Description: Name of ansatz quantum circuit to use, default=&#39;EfficientSU2&#39;
            Type: string
            Required: False
        - ansatz_config:
            Description: Configuration parameters for the ansatz circuit.
            Type: object
            Required: False
        - hamiltonian:
            Description: Hamiltonian whose ground state we want to find.
            Type: array
            Required: True
        - optimizer:
            Default: SPSA
            Description: Classical optimizer to use, default=&#39;SPSA&#39;.
            Type: string
            Required: False
        - optimizer_config:
            Description: Configuration parameters for the optimizer.
            Type: object
            Required: False
        - shots:
            Description: The number of shots used for each circuit evaluation.
            Type: integer
            Required: False
        - use_measurement_mitigation:
            Default: False
            Description: Use measurement mitigation, default=False.
            Type: boolean
            Required: False
        - x0:
            Description: Initial vector of parameters. This is a numpy array.
            Type: array
            Required: False
  Interim results:
    Description: Parameter vector at current optimization step. This is a numpy array.
    Type: array
  Returns:
    Description: Final result in SciPy optimizer format
    Type: object
</pre></div></div>
</div>
</section>
<section id="Deleting-a-program">
<h3>Deleting a program<a class="headerlink" href="#Deleting-a-program" title="Permalink to this heading">¶</a></h3>
<p>If you make a mistake and need to delete and/or re-upload the program, you can run the following, passing the <code class="docutils literal notranslate"><span class="pre">program_id</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># service.delete_program(program_id)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Running-the-program">
<h2>Running the program<a class="headerlink" href="#Running-the-program" title="Permalink to this heading">¶</a></h2>
<section id="Specify-parameters">
<h3>Specify parameters<a class="headerlink" href="#Specify-parameters" title="Permalink to this heading">¶</a></h3>
<p>To run the program we need to specify the <code class="docutils literal notranslate"><span class="pre">options</span></code> that are used in the runtime environment (not the program variables). The target backend is defined via the <code class="docutils literal notranslate"><span class="pre">backend_name</span></code> field.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;backend_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ibmq_qasm_simulator&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">inputs</span></code> dictionary is used to pass arguments to the <code class="docutils literal notranslate"><span class="pre">main</span></code> function itself. For example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;hamiltonian&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
<span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Execute-the-program">
<h3>Execute the program<a class="headerlink" href="#Execute-the-program" title="Permalink to this heading">¶</a></h3>
<p>We now can execute the program and grab the result.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;fun&#39;: -2.949462890625,
 &#39;x&#39;: array([2.5318168 , 0.49480149, 5.00109975, 3.70277244, 4.20642682,
        7.36485888, 5.06392524, 3.84919527, 3.84548761, 7.1476062 ,
        4.87591204, 3.81509087, 1.10323387, 6.93862146, 2.90764433,
        2.17991845]),
 &#39;nit&#39;: 10,
 &#39;nfev&#39;: 20,
 &#39;message&#39;: &#39;Optimization terminated successfully.&#39;,
 &#39;success&#39;: True}
</pre></div></div>
</div>
<p>A few things need to be pointed out. First, we did not get back any interim results, and second, the return object is a plain dictionary. This is because we did not listen for the return results, and we did not tell the job how to format the return result.</p>
</section>
<section id="Listening-for-interim-results-and-final-result">
<h3>Listening for interim results and final result<a class="headerlink" href="#Listening-for-interim-results-and-final-result" title="Permalink to this heading">¶</a></h3>
<p>To listen for interim results and final result we need to pass a callback function to <code class="docutils literal notranslate"><span class="pre">service.run</span></code> that stores the results. The callback takes two arguments <code class="docutils literal notranslate"><span class="pre">job_id</span></code> and the returned data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interim_results</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">vqe_callback</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">interim_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Executing again we get:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job2</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">vqe_callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job2</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;fun&#39;: -1.093017578125,
 &#39;x&#39;: array([ 3.02333056,  4.50664166,  5.81302828,  7.29337359, -0.1059841 ,
         5.63644887,  4.85551666,  1.08600079,  2.43038435, -0.44482119,
         3.57615685,  4.55828624,  3.88114462,  2.39233825,  2.44894464,
        -0.54914487]),
 &#39;nit&#39;: 10,
 &#39;nfev&#39;: 20,
 &#39;message&#39;: &#39;Optimization terminated successfully.&#39;,
 &#39;success&#39;: True}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">interim_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[2.6226514863095396, 5.853032658380542, 6.509858654413924, 6.507245447857467, 0.5942894562887755, 3.79956161425515, 3.6960116623043113, 1.96793326187455, 2.8807692270500427, -0.2725407393367527, 3.1327517130311757, 2.997229503101964, 4.55015337012571, 2.4196404687436326, 1.5251463004377124, -0.2649036387111905], [3.078139836547118, 5.3975443081429635, 6.054370304176346, 6.962733798095045, 0.13880110605119705, 4.255049964492729, 4.15150001254189, 1.5124449116369716, 2.4252808768124643, -0.7280290895743311, 2.6772633627935973, 3.4527178533395424, 4.094665019888132, 1.9641521185060542, 1.9806346506752908, 0.19058471152638795], [3.04818345917541, 5.427500685514672, 6.084326681548054, 6.992690175466754, 0.16875748342290509, 4.2250935871210205, 4.121543635170181, 1.4824885342652636, 2.4552372541841723, -0.7579854669460392, 2.6473069854218894, 3.4227614759678344, 4.1246213972598404, 1.9341957411343462, 2.0105910280469987, 0.22054108889809598], [3.003445259194044, 5.472238885496037, 6.039588481566689, 7.037428375448119, 0.21349568340427083, 4.269831787102386, 4.166281835151547, 1.437750334283898, 2.4104990542028064, -0.8027236669274049, 2.692045185403255, 3.4674996759492003, 4.169359597241206, 1.9789339411157119, 1.965852828065633, 0.2652792888794617], [2.633926747429298, 5.102720373731291, 6.409106993331435, 7.406946887212865, 0.5830141951690169, 4.639350298867132, 4.535800346916293, 1.807268846048644, 2.0409805424380605, -0.43320515516265895, 3.061563697168001, 3.837018187713946, 3.79984108547646, 2.348452452880458, 2.3353713398303793, -0.10423922288528426], [2.8344366723450003, 5.303230298646993, 6.609616918247138, 7.607456812128568, 0.3825042702533148, 4.839860223782834, 4.736310271831995, 2.0077787709643458, 2.2414904673537626, -0.6337150800783611, 3.262073622083703, 3.636508262798244, 4.000351010392162, 2.147942527964756, 2.134861414914677, -0.30474914780098633], [2.530589294860351, 4.9993829211623435, 6.305769540762489, 7.911304189613217, 0.07865689276866544, 5.143707601267483, 5.040157649316644, 1.7039313934796965, 1.9376430898691133, -0.9375624575630104, 2.9582262445990537, 3.9403556402828936, 3.6965036329075125, 2.4517899054494054, 1.8310140374300279, -0.6085965252856357], [2.869280422196153, 4.660691793826541, 5.9670784134266865, 7.572613062277415, -0.2600342345671368, 5.482398728603285, 4.701466521980842, 1.3652402661438943, 2.2763342172049157, -0.5988713302272082, 3.296917371934856, 4.279046767618696, 4.035194760243315, 2.1130987781136032, 2.1697051647658303, -0.2699053979498334], [2.8066857530033054, 4.723286463019389, 6.029673082619534, 7.510018393084567, -0.32262890375998443, 5.4198040594104375, 4.638871852787994, 1.3026455969510466, 2.213739548012068, -0.6614659994200558, 3.3595120411277035, 4.3416414368115435, 4.097789429436163, 2.175693447306451, 2.232299833958678, -0.33250006714268104], [3.023330559942476, 4.506641656080218, 5.813028275680363, 7.293373586145396, -0.10598409682081364, 5.636448866349609, 4.855516659727165, 1.0860007900118758, 2.4303843549512387, -0.44482119248088503, 3.576156848066874, 4.558286243750715, 3.881144622496992, 2.3923382542456215, 2.4489446408978486, -0.5491448740818519]]
</pre></div></div>
</div>
</section>
<section id="Formatting-the-returned-results">
<h3>Formatting the returned results<a class="headerlink" href="#Formatting-the-returned-results" title="Permalink to this heading">¶</a></h3>
<p>In order to format the return results into the desired format, we need to specify a decoder. This decoder must have a <code class="docutils literal notranslate"><span class="pre">decode</span></code> method that gets called to do the actual conversion. In our case <code class="docutils literal notranslate"><span class="pre">OptimizeResult</span></code> is a simple sub-class of <code class="docutils literal notranslate"><span class="pre">dict</span></code> so the formatting is simple.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit_ibm_runtime.program</span> <span class="kn">import</span> <span class="n">ResultDecoder</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>


<span class="k">class</span> <span class="nc">VQEResultDecoder</span><span class="p">(</span><span class="n">ResultDecoder</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># This is required to preformat the data returned.</span>
        <span class="k">return</span> <span class="n">OptimizeResult</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can then use this when returning the job result:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job3</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">job3</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">decoder</span><span class="o">=</span><span class="n">VQEResultDecoder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     fun: 0.796630859375
 message: &#39;Optimization terminated successfully.&#39;
    nfev: 20
     nit: 10
 success: True
       x: array([ 5.15928009,  2.08106352,  3.54177277,  4.6777056 , -0.02584765,
        5.68333129,  3.63600881,  3.11541328,  0.49660675,  4.0718595 ,
        1.79637632,  0.64611396,  3.64174244,  5.66668821,  0.98273154,
        1.33338277])
</pre></div></div>
</div>
</section>
</section>
<section id="Simplifying-program-execution-with-wrapping-functions">
<h2>Simplifying program execution with wrapping functions<a class="headerlink" href="#Simplifying-program-execution-with-wrapping-functions" title="Permalink to this heading">¶</a></h2>
<p>While runtime programs are powerful and flexible, they are not the most friendly things to interact with. Therefore, if your program is intended to be used by others, it is best to make wrapper functions and/or classes that simplify the user experience. Moreover, such wrappers allow for validation of user inputs on the client side, which can quickly find errors that would otherwise be raised later during the execution process - something that might have taken hours waiting in queue to get to.</p>
<p>Here we will make two helper routines. First, a job wrapper that allows us to attach and retrieve the interim results directly from the job object itself, as well as decodes for us so that the end user need not worry about formatting the results themselves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RuntimeJobWrapper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A simple Job wrapper that attaches interim results directly to the job object itself</span>
<span class="sd">    in the `interim_results attribute` via the `_callback` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decoder</span> <span class="o">=</span> <span class="n">VQEResultDecoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interim_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">xk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The callback function that attaches interim results:</span>

<span class="sd">        Parameters:</span>
<span class="sd">            job_id (str): The job ID.</span>
<span class="sd">            xk (array_like): A list or NumPy array to attach.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interim_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Class does not have </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the result of the job as a SciPy OptimizerResult object.</span>

<span class="sd">        This blocks until job is done, cancelled, or errors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            OptimizerResult: A SciPy optimizer result object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_decoder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next, we create the actual function we want users to call to execute our program. To this function we will add a series of simple validation checks (not all checks will be done for simplicity), as well as use the job wrapper defined above to simply the output.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">qiskit.circuit.library.n_local</span> <span class="k">as</span> <span class="nn">lib_local</span>


<span class="k">def</span> <span class="nf">vqe_runner</span><span class="p">(</span>
    <span class="n">backend</span><span class="p">,</span>
    <span class="n">hamiltonian</span><span class="p">,</span>
    <span class="n">ansatz</span><span class="o">=</span><span class="s2">&quot;EfficientSU2&quot;</span><span class="p">,</span>
    <span class="n">ansatz_config</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;SPSA&quot;</span><span class="p">,</span>
    <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
    <span class="n">shots</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
    <span class="n">use_measurement_mitigation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Routine that executes a given VQE problem via the sample-vqe program on the target backend.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        backend (ProgramBackend): Qiskit backend instance.</span>
<span class="sd">        hamiltonian (list): Hamiltonian whose ground state we want to find.</span>
<span class="sd">        ansatz (str): Optional, name of ansatz quantum circuit to use, default=&#39;EfficientSU2&#39;</span>
<span class="sd">        ansatz_config (dict): Optional, configuration parameters for the ansatz circuit.</span>
<span class="sd">        x0 (array_like): Optional, initial vector of parameters.</span>
<span class="sd">        optimizer (str): Optional, string specifying classical optimizer, default=&#39;SPSA&#39;.</span>
<span class="sd">        optimizer_config (dict): Optional, configuration parameters for the optimizer.</span>
<span class="sd">        shots (int): Optional, number of shots to take per circuit.</span>
<span class="sd">        use_measurement_mitigation (bool): Optional, use measurement mitigation, default=False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        OptimizeResult: The result in SciPy optimization format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;backend_name&quot;</span><span class="p">:</span> <span class="n">backend</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Validate Hamiltonian is correct</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ham</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hamiltonian</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ham</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">num_qubits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Number of qubits in Hamiltonian term </span><span class="si">{}</span><span class="s2"> does not match </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">num_qubits</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;hamiltonian&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hamiltonian</span>

    <span class="c1"># Validate ansatz is in the module</span>
    <span class="n">ansatz_circ</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lib_local</span><span class="p">,</span> <span class="n">ansatz</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ansatz_circ</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ansatz </span><span class="si">{}</span><span class="s2"> not in n_local circuit library.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ansatz</span><span class="p">))</span>

    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;ansatz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ansatz</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;ansatz_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ansatz_config</span>

    <span class="c1"># If given x0, validate its length against num_params in ansatz:</span>
    <span class="k">if</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">ansatz_circ</span> <span class="o">=</span> <span class="n">ansatz_circ</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="o">**</span><span class="n">ansatz_config</span><span class="p">)</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="n">ansatz_circ</span><span class="o">.</span><span class="n">num_parameters</span>
        <span class="k">if</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Length of x0 </span><span class="si">{}</span><span class="s2"> does not match number of params in ansatz </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_params</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>

    <span class="c1"># Set the rest of the inputs</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_config</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;shots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shots</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;use_measurement_mitigation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_measurement_mitigation</span>

    <span class="n">rt_job</span> <span class="o">=</span> <span class="n">RuntimeJobWrapper</span><span class="p">()</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">program_id</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">rt_job</span><span class="o">.</span><span class="n">_callback</span>
    <span class="p">)</span>
    <span class="n">rt_job</span><span class="o">.</span><span class="n">_job</span> <span class="o">=</span> <span class="n">job</span>

    <span class="k">return</span> <span class="n">rt_job</span>
</pre></div>
</div>
</div>
<p>We can now execute our runtime program via this runner function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">backend</span><span class="p">(</span><span class="s2">&quot;ibmq_qasm_simulator&quot;</span><span class="p">)</span>
<span class="n">job4</span> <span class="o">=</span> <span class="n">vqe_runner</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">optimizer_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job4</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     fun: -0.34814453125
 message: &#39;Optimization terminated successfully.&#39;
    nfev: 30
     nit: 15
 success: True
       x: array([4.17997325, 2.0676416 , 0.26748687, 1.66069543, 1.7689056 ,
       4.61847717, 0.34955838, 1.5071607 , 0.29674753, 3.37945792,
       1.25076358, 2.91525347, 4.75856526, 7.1439898 , 2.5695465 ,
       2.67008381])
</pre></div></div>
</div>
<p>The interim results are now attached to the job <code class="docutils literal notranslate"><span class="pre">interim_results</span></code> attribute and, as expected, we see that the length matches the number of iterations performed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">job4</span><span class="o">.</span><span class="n">interim_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
15
</pre></div></div>
</div>
</section>
<section id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Permalink to this heading">¶</a></h2>
<p>We have demonstrated how to create, upload, and use a custom Qiskit Runtime by creating our own VQE solver from scratch. This tutorial was meant to touch upon every aspect of the process for a real-world example. Within the current limitations of the runtime environment, this example should enable readers to develop their own single-file runtime program. This program is also a good starting point for exploring additional flavors of VQE runtime. For example, it is straightforward to vary the
number of shots per iteration, increasing shots as the number of iterations increases. Those looking to go deeper can consider implimenting an <a class="reference external" href="https://doi.org/10.1038/s41467-019-10988-2">adaptive VQE</a>, where the ansatz is not fixed at initialization.</p>
</section>
<section id="Appendix-A">
<h2>Appendix A<a class="headerlink" href="#Appendix-A" title="Permalink to this heading">¶</a></h2>
<p>Here we code a simple simultaneous perturbation stochastic approximation (SPSA) optimizer for use on noisy quantum systems. Most optimizers do not handle fluctuating cost functions well, so this is a needed addition for executing on real quantum hardware.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>


<span class="k">def</span> <span class="nf">fmin_spsa</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">x0</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">a</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.602</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">gamma</span><span class="o">=</span><span class="mf">0.101</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimization of scalar function of one or more variables using simultaneous</span>
<span class="sd">    perturbation stochastic approximation (SPSA).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        func (callable): The objective function to be minimized.</span>

<span class="sd">                          ``fun(x, *args) -&gt; float``</span>

<span class="sd">                          where x is an 1-D array with shape (n,) and args is a</span>
<span class="sd">                          tuple of the fixed parameters needed to completely</span>
<span class="sd">                          specify the function.</span>

<span class="sd">        x0 (ndarray): Initial guess. Array of real elements of size (n,),</span>
<span class="sd">                      where ‘n’ is the number of independent variables.</span>

<span class="sd">        maxiter (int): Maximum number of iterations.  The number of function</span>
<span class="sd">                       evaluations is twice as many. Optional.</span>

<span class="sd">        a (float): SPSA gradient scaling parameter. Optional.</span>

<span class="sd">        alpha (float): SPSA gradient scaling exponent. Optional.</span>

<span class="sd">        c (float):  SPSA step size scaling parameter. Optional.</span>

<span class="sd">        gamma (float): SPSA step size scaling exponent. Optional.</span>

<span class="sd">        callback (callable): Function that accepts the current parameter vector</span>
<span class="sd">                             as input.</span>

<span class="sd">    Returns:</span>
<span class="sd">        OptimizeResult: Solution in SciPy Optimization format.</span>

<span class="sd">    Notes:</span>
<span class="sd">        See the `SPSA homepage &lt;https://www.jhuapl.edu/SPSA/&gt;`_ for usage and</span>
<span class="sd">        additional extentions to the basic version implimented here.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">maxiter</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>

    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">kk</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="n">alpha</span>
        <span class="n">ck</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">kk</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="n">gamma</span>
        <span class="c1"># Bernoulli distribution for randoms</span>
        <span class="n">deltak</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ck</span> <span class="o">*</span> <span class="n">deltak</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ck</span> <span class="o">*</span> <span class="n">deltak</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">ck</span> <span class="o">*</span> <span class="n">deltak</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">ak</span> <span class="o">*</span> <span class="n">grad</span>

        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">OptimizeResult</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
        <span class="n">nit</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
        <span class="n">nfev</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">maxiter</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Optimization terminated successfully.&quot;</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Appendix-B">
<h2>Appendix B<a class="headerlink" href="#Appendix-B" title="Permalink to this heading">¶</a></h2>
<p>This is a helper function that converts the Pauli operators in the strings that define the Hamiltonian operators into the appropriate measurements at the end of the circuits. For <span class="math notranslate nohighlight">\(X\)</span> operators this involves adding an <span class="math notranslate nohighlight">\(H\)</span> gate to the qubits to be measured, whereas a <span class="math notranslate nohighlight">\(Y\)</span> operator needs <span class="math notranslate nohighlight">\(S^{+}\)</span> followed by a <span class="math notranslate nohighlight">\(H\)</span>. Other choices of Pauli operators require no additional gates prior to measurement.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">opstr_to_meas_circ</span><span class="p">(</span><span class="n">op_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a list of operator strings and makes circuit with the correct post-rotations for measurements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        op_str (list): List of strings representing the operators needed for measurements.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of circuits for measurement post-rotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">circs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_str</span><span class="p">:</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">num_qubits</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">sdg</span><span class="p">(</span><span class="n">num_qubits</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">num_qubits</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">circs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circs</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit.tools.jupyter</span> <span class="kn">import</span> <span class="o">*</span>

<span class="o">%</span><span class="k">qiskit_copyright</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div style='width: 100%; background-color:#d5d9e0;padding-left: 10px; padding-bottom: 10px; padding-right: 10px; padding-top: 5px'><h3>This code is a part of Qiskit</h3><p>&copy; Copyright IBM 2017, 2021.</p><p>This code is licensed under the Apache License, Version 2.0. You may<br>obtain a copy of this license in the LICENSE.txt file in the root directory<br> of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.<p>Any modifications or derivative works of this code must retain this<br>copyright notice, and modified files need to carry a notice indicating<br>that they have been altered from the originals.</p></div></div>
</div>
</section>
</section>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../sample_expval_program/qiskit_runtime_expval_program.html" class="btn btn-neutral float-right" title="Custom Expectation Value Program for the Qiskit Runtime" accesskey="n" rel="next">Next <img src="../../_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="../05_uploading_program.html" class="btn btn-neutral" title="Uploading a Qiskit runtime program" accesskey="p" rel="prev"><img src="../../_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Qiskit Development Team.
      Обновлено: 2022/07/14.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Creating Custom Programs for Qiskit Runtime</a><ul>
<li><a class="reference internal" href="#Prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#Current-limitations">Current limitations</a></li>
<li><a class="reference internal" href="#Simple-VQE">Simple VQE</a></li>
<li><a class="reference internal" href="#Specifying-the-form-of-the-input-values">Specifying the form of the input values</a><ul>
<li><a class="reference internal" href="#Optionals">Optionals</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Main-program">Main program</a><ul>
<li><a class="reference internal" href="#Required-signature">Required signature</a></li>
<li><a class="reference internal" href="#The-main-VQE-program">The main VQE program</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Local-testing">Local testing</a></li>
<li><a class="reference internal" href="#Program-metadata">Program metadata</a></li>
<li><a class="reference internal" href="#Uploading-the-program">Uploading the program</a><ul>
<li><a class="reference internal" href="#Program-upload">Program upload</a></li>
<li><a class="reference internal" href="#Program-information">Program information</a></li>
<li><a class="reference internal" href="#Deleting-a-program">Deleting a program</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Running-the-program">Running the program</a><ul>
<li><a class="reference internal" href="#Specify-parameters">Specify parameters</a></li>
<li><a class="reference internal" href="#Execute-the-program">Execute the program</a></li>
<li><a class="reference internal" href="#Listening-for-interim-results-and-final-result">Listening for interim results and final result</a></li>
<li><a class="reference internal" href="#Formatting-the-returned-results">Formatting the returned results</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Simplifying-program-execution-with-wrapping-functions">Simplifying program execution with wrapping functions</a></li>
<li><a class="reference internal" href="#Conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#Appendix-A">Appendix A</a></li>
<li><a class="reference internal" href="#Appendix-B">Appendix B</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
         <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
         <script src="../../_static/jquery.js"></script>
         <script src="../../_static/underscore.js"></script>
         <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../_static/doctools.js"></script>
         <script src="../../_static/thebelab-helper.js"></script>
         <script src="../../_static/translations.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
         <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
         <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
         <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
         <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
     

  

  <script type="text/javascript" src="../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <div>
    <br>
  </div>

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://qiskit.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="../../getting_started.html">Getting Started</a>
          </li>
          <li>
            <a href="../../tutorials.html">Tutorials</a>
          </li>
          <li>
            <a href="https://qiskit.org/documentation/partners/">Qiskit Providers</a>
          </li>
          <br>
          <li class="resources-mobile-menu-title">
            Applications
          </li>
          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://qiskit.org/documentation/machine-learning/">Machine learning</a>
            </li>

            <li>
              <a href="https://qiskit.org/documentation/nature/">Nature</a>
            </li>

            <li>
              <a href="https://qiskit.org/documentation/finance/">Finance</a>
            </li>

            <li>
              <a href="https://qiskit.org/documentation/optimization/">Optimization</a>
            </li>
          </ul>

          <br>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://qiskit.slack.com">Slack support</a>
            </li>
          </ul>
          <br>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>