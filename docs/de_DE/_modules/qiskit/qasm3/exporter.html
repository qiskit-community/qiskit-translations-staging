


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="de-DE" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="de-DE" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qiskit.qasm3.exporter &mdash; Qiskit 0.37.0 Dokumentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme-override.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Stichwortverzeichnis" href="../../../genindex.html" />
    <link rel="search" title="Suche" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://qiskit.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="../../../getting_started.html">Getting started</a>
          </li>

          <li>
            <a href="../../../tutorials.html">Tutorials</a>
          </li>

          <li>
            <a href="https://qiskit.org/documentation/partners/" target="_blank">Partners</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Applications
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/machine-learning/">
                  <span class="dropdown-title">Machine learning</span>
                  <p>QSVM, VQC (Variational Quantum Classifier), and QGAN (Quantum Generative
                    Adversarial Network) algorithms.</p>
                </a>
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/nature/">
                  <span class="dropdown-title">Nature</span>
                  <p>Quantum applications in chemistry, physics, and biology.</p>
                </a>
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/finance/">
                  <span class="dropdown-title">Finance</span>
                  <p>Uncertainty components for stock/securities problems, Ising translators for
                    portfolio optimizations and data providers to source real or random data.</p>
                </a>
                <a class="nav-dropdown-item" href="https://qiskit.org/documentation/optimization/">
                  <span class="dropdown-title">Optimization</span>
                  <p>High-level optimization problems that are ready to
                    run on simulators and real quantum devices</p>
                </a>
              </div>
          </li>
          <li>
              <a href="https://qiskit.org/documentation/experiments/" target="_blank">Experiments</a>
          </li>
          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://qiskit.slack.com">
                  <span class="dropdown-title">Slack support</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://qiskit.org/textbook">
                  <span class="dropdown-title">Qiskit Textbook</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://qiskit.org/events">
                  <span class="dropdown-title">Qiskit events</span>
                  <p></p>
                </a>
            </div>
          </li>
          <li>
            <a href="https://github.com/Qiskit/" target="_blank">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="rst-current-version-label">German</span>
    <span class="rst-versions-dropdown-icon"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>Sprachen</dt>
      
        <dd><a class="version" href="/documentation/_modules/qiskit/qasm3/exporter.html">English</a></dd>
      
        <dd><a class="version" href="/documentation/locale/bn_BN/_modules/qiskit/qasm3/exporter.html">Bengali</a></dd>
      
        <dd><a class="version" href="/documentation/locale/fr_FR/_modules/qiskit/qasm3/exporter.html">French</a></dd>
      
        <dd><a class="version" href="/documentation/locale/de_DE/_modules/qiskit/qasm3/exporter.html">German</a></dd>
      
        <dd><a class="version" href="/documentation/locale/ja_JP/_modules/qiskit/qasm3/exporter.html">Japanese</a></dd>
      
        <dd><a class="version" href="/documentation/locale/ko_KR/_modules/qiskit/qasm3/exporter.html">Korean</a></dd>
      
        <dd><a class="version" href="/documentation/locale/pt_UN/_modules/qiskit/qasm3/exporter.html">Portuguese</a></dd>
      
        <dd><a class="version" href="/documentation/locale/es_UN/_modules/qiskit/qasm3/exporter.html">Spanish</a></dd>
      
        <dd><a class="version" href="/documentation/locale/ta_IN/_modules/qiskit/qasm3/exporter.html">Tamil</a></dd>
      
    </dl>
    
    <dl>
      <dt>Previous Releases</dt>
      
        <dd><a class="version" href="/documentation/stable/0.19/index.html">0.19</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.24/index.html">0.24</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.25/index.html">0.25</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.26/index.html">0.26</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.27/index.html">0.27</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.28/index.html">0.28</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.29/index.html">0.29</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.30/index.html">0.30</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.31/index.html">0.31</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.32/index.html">0.32</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.33/index.html">0.33</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.34/index.html">0.34</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.35/index.html">0.35</a></dd>
      
        <dd><a class="version" href="/documentation/stable/0.36/index.html">0.36</a></dd>
      
    </dl>
  </div>
  <script>
    jQuery('.version').click((evt) => {
      const hash = window.location.hash
      const complete_url = evt.target.href + hash
      window.location = complete_url
      evt.preventDefault()
    })
  </script>
</div>

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Homepage der Dokumentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Titelblatt</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../qc_intro.html">Quantum Computing auf den Punkt gebracht</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro_tutorial1.html">Einführung in Qiskit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing_to_qiskit.html">An Qiskit mitwirken</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Lokale Konfiguration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Häufig gestellte Fragen</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bibliotheken</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/circuit_library.html">Schaltkreisbibliotheken</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API-Referenzen</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/terra.html">Qiskit Terra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/aer.html">Qiskit Aer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/ibmq-provider.html">Qiskit IBM Quantum Provider</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Problembehandlung</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://quantum-computing.ibm.com/lab/docs/iql/manage/errors">IBM Quantum API Fehlercodes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Modul-Quellcode</a> &gt;</li>
        
          <li><a href="../qasm3.html">qiskit.qasm3</a> &gt;</li>
        
      <li>qiskit.qasm3.exporter</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">
          
          <div class="rst-content style-external-links">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Quellcode für qiskit.qasm3.exporter</h1><div class="highlight"><pre>
<span></span><span class="c1"># This code is part of Qiskit.</span>
<span class="c1">#</span>
<span class="c1"># (C) Copyright IBM 2021.</span>
<span class="c1">#</span>
<span class="c1"># This code is licensed under the Apache License, Version 2.0. You may</span>
<span class="c1"># obtain a copy of this license in the LICENSE.txt file in the root directory</span>
<span class="c1"># of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.</span>
<span class="c1">#</span>
<span class="c1"># Any modifications or derivative works of this code must retain this</span>
<span class="c1"># copyright notice, and modified files need to carry a notice indicating</span>
<span class="c1"># that they have been altered from the originals.</span>

<span class="sd">&quot;&quot;&quot;QASM3 Exporter&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">abspath</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">qiskit.circuit</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Barrier</span><span class="p">,</span>
    <span class="n">CircuitInstruction</span><span class="p">,</span>
    <span class="n">Clbit</span><span class="p">,</span>
    <span class="n">Gate</span><span class="p">,</span>
    <span class="n">Instruction</span><span class="p">,</span>
    <span class="n">Measure</span><span class="p">,</span>
    <span class="n">Parameter</span><span class="p">,</span>
    <span class="n">ParameterExpression</span><span class="p">,</span>
    <span class="n">QuantumCircuit</span><span class="p">,</span>
    <span class="n">QuantumRegister</span><span class="p">,</span>
    <span class="n">Qubit</span><span class="p">,</span>
    <span class="n">Reset</span><span class="p">,</span>
    <span class="n">Delay</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.bit</span> <span class="kn">import</span> <span class="n">Bit</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.controlflow</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IfElseOp</span><span class="p">,</span>
    <span class="n">ForLoopOp</span><span class="p">,</span>
    <span class="n">WhileLoopOp</span><span class="p">,</span>
    <span class="n">ControlFlowOp</span><span class="p">,</span>
    <span class="n">BreakLoopOp</span><span class="p">,</span>
    <span class="n">ContinueLoopOp</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.library</span> <span class="kn">import</span> <span class="n">standard_gates</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.register</span> <span class="kn">import</span> <span class="n">Register</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.tools</span> <span class="kn">import</span> <span class="n">pi_check</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ast</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">QASM3ExporterError</span>
<span class="kn">from</span> <span class="nn">.printer</span> <span class="kn">import</span> <span class="n">BasicPrinter</span>


<span class="c1"># Reserved keywords that gates and variables cannot be named.  It is possible that some of these</span>
<span class="c1"># _could_ be accepted as variable names by OpenQASM 3 parsers, but it&#39;s safer for us to just be very</span>
<span class="c1"># conservative.</span>
<span class="n">_RESERVED_KEYWORDS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;OPENQASM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;U&quot;</span><span class="p">,</span>
        <span class="s2">&quot;angle&quot;</span><span class="p">,</span>
        <span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="s2">&quot;barrier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;box&quot;</span><span class="p">,</span>
        <span class="s2">&quot;break&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;complex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;const&quot;</span><span class="p">,</span>
        <span class="s2">&quot;continue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;creg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ctrl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;def&quot;</span><span class="p">,</span>
        <span class="s2">&quot;defcal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;defcalgrammar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;delay&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;durationof&quot;</span><span class="p">,</span>
        <span class="s2">&quot;else&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end&quot;</span><span class="p">,</span>
        <span class="s2">&quot;extern&quot;</span><span class="p">,</span>
        <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;for&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gphase&quot;</span><span class="p">,</span>
        <span class="s2">&quot;if&quot;</span><span class="p">,</span>
        <span class="s2">&quot;in&quot;</span><span class="p">,</span>
        <span class="s2">&quot;include&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input&quot;</span><span class="p">,</span>
        <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;let&quot;</span><span class="p">,</span>
        <span class="s2">&quot;measure&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mutable&quot;</span><span class="p">,</span>
        <span class="s2">&quot;negctrl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;qreg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;qubit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sizeof&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stretch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;uint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;while&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>


<div class="viewcode-block" id="Exporter"><a class="viewcode-back" href="../../../stubs/qiskit.qasm3.Exporter.html#qiskit.qasm3.Exporter">[Doku]</a><span class="k">class</span> <span class="nc">Exporter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;QASM3 expoter main class.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">includes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;stdgates.inc&quot;</span><span class="p">,),</span>
        <span class="n">basis_gates</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,),</span>
        <span class="n">disable_constants</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">alias_classical_registers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">indent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            includes: the filenames that should be emitted as includes.  These files will be parsed</span>
<span class="sd">                for gates, and any objects dumped from this exporter will use those definitions</span>
<span class="sd">                where possible.</span>
<span class="sd">            basis_gates: the basic defined gate set of the backend.</span>
<span class="sd">            disable_constants: if ``True``, always emit floating-point constants for numeric</span>
<span class="sd">                parameter values.  If ``False`` (the default), then values close to multiples of</span>
<span class="sd">                QASM 3 constants (``pi``, ``euler``, and ``tau``) will be emitted in terms of those</span>
<span class="sd">                constants instead, potentially improving accuracy in the output.</span>
<span class="sd">            alias_classical_registers: If ``True``, then classical bit and classical register</span>
<span class="sd">                declarations will look similar to quantum declarations, where the whole set of bits</span>
<span class="sd">                will be declared in a flat array, and the registers will just be aliases to</span>
<span class="sd">                collections of these bits.  This is inefficient for running OpenQASM 3 programs,</span>
<span class="sd">                however, and may not be well supported on backends.  Instead, the default behaviour</span>
<span class="sd">                of ``False`` means that individual classical registers will gain their own</span>
<span class="sd">                ``bit[size] register;`` declarations, and loose :obj:`.Clbit`\\ s will go onto their</span>
<span class="sd">                own declaration.  In this form, each :obj:`.Clbit` must be in either zero or one</span>
<span class="sd">                :obj:`.ClassicalRegister`\\ s.</span>
<span class="sd">            indent: the indentation string to use for each level within an indented block.  Can be</span>
<span class="sd">                set to the empty string to disable indentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis_gates</span> <span class="o">=</span> <span class="n">basis_gates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_constants</span> <span class="o">=</span> <span class="n">disable_constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_classical_registers</span> <span class="o">=</span> <span class="n">alias_classical_registers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">includes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">indent</span>

<div class="viewcode-block" id="Exporter.dumps"><a class="viewcode-back" href="../../../stubs/qiskit.qasm3.Exporter.dumps.html#qiskit.qasm3.Exporter.dumps">[Doku]</a>    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the circuit to QASM 3, returning the result as a string.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>

<div class="viewcode-block" id="Exporter.dump"><a class="viewcode-back" href="../../../stubs/qiskit.qasm3.Exporter.dump.html#qiskit.qasm3.Exporter.dump">[Doku]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the circuit to QASM 3, dumping the result to a file or text stream.&quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">QASM3Builder</span><span class="p">(</span>
            <span class="n">circuit</span><span class="p">,</span>
            <span class="n">includeslist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">includes</span><span class="p">,</span>
            <span class="n">basis_gates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_gates</span><span class="p">,</span>
            <span class="n">disable_constants</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_constants</span><span class="p">,</span>
            <span class="n">alias_classical_registers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_classical_registers</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">BasicPrinter</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">build_program</span><span class="p">())</span></div></div>


<span class="k">class</span> <span class="nc">GlobalNamespace</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Global namespace dict-like.&quot;&quot;&quot;</span>

    <span class="n">BASIS_GATE</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

    <span class="n">qiskit_gates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">PhaseGate</span><span class="p">,</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">XGate</span><span class="p">,</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">YGate</span><span class="p">,</span>
        <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">ZGate</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">HGate</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">SGate</span><span class="p">,</span>
        <span class="s2">&quot;sdg&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">SdgGate</span><span class="p">,</span>
        <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">TGate</span><span class="p">,</span>
        <span class="s2">&quot;tdg&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">TdgGate</span><span class="p">,</span>
        <span class="s2">&quot;sx&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">SXGate</span><span class="p">,</span>
        <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">RXGate</span><span class="p">,</span>
        <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">RYGate</span><span class="p">,</span>
        <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">RZGate</span><span class="p">,</span>
        <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CXGate</span><span class="p">,</span>
        <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CYGate</span><span class="p">,</span>
        <span class="s2">&quot;cz&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CZGate</span><span class="p">,</span>
        <span class="s2">&quot;cp&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CPhaseGate</span><span class="p">,</span>
        <span class="s2">&quot;crx&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CRXGate</span><span class="p">,</span>
        <span class="s2">&quot;cry&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CRYGate</span><span class="p">,</span>
        <span class="s2">&quot;crz&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CRZGate</span><span class="p">,</span>
        <span class="s2">&quot;ch&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CHGate</span><span class="p">,</span>
        <span class="s2">&quot;swap&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">SwapGate</span><span class="p">,</span>
        <span class="s2">&quot;ccx&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CCXGate</span><span class="p">,</span>
        <span class="s2">&quot;cswap&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CSwapGate</span><span class="p">,</span>
        <span class="s2">&quot;cu&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CUGate</span><span class="p">,</span>
        <span class="s2">&quot;CX&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CXGate</span><span class="p">,</span>
        <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">PhaseGate</span><span class="p">,</span>
        <span class="s2">&quot;cphase&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">CPhaseGate</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">IGate</span><span class="p">,</span>
        <span class="s2">&quot;u1&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">U1Gate</span><span class="p">,</span>
        <span class="s2">&quot;u2&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">U2Gate</span><span class="p">,</span>
        <span class="s2">&quot;u3&quot;</span><span class="p">:</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">U3Gate</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">include_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;qasm&quot;</span><span class="p">,</span> <span class="s2">&quot;libs&quot;</span><span class="p">))]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">includelist</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">gate</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASIS_GATE</span> <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">basis_gates</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">includefile</span> <span class="ow">in</span> <span class="n">includelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">includefile</span> <span class="o">==</span> <span class="s2">&quot;stdgates.inc&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qiskit_gates</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO What do if an inc file is not standard?</span>
                <span class="c1"># Should it be parsed?</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_str</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">name_str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">instruction</span><span class="p">)]</span> <span class="o">=</span> <span class="n">name_str</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Instruction</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Registered gates.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Built-in gates.</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">UGate</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASIS_GATE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Gate</span><span class="p">,</span> <span class="n">Instruction</span><span class="p">]:</span>  <span class="c1"># user-defined instructions/gate</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">instruction</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an instruction in the namespace&quot;&quot;&quot;</span>
        <span class="c1"># The second part of the condition is a nasty hack to ensure that gates that come with at</span>
        <span class="c1"># least one parameter always have their id in the name.  This is a workaround a bug, where</span>
        <span class="c1"># gates with parameters do not contain the information required to build the gate definition</span>
        <span class="c1"># in symbolic form (unless the parameters are all symbolic).  The exporter currently</span>
        <span class="c1"># (2021-12-01) builds gate declarations with parameters in the signature, but then ignores</span>
        <span class="c1"># those parameters during the body, and just uses the concrete values from the first</span>
        <span class="c1"># instance of the gate it sees, such as:</span>
        <span class="c1">#     gate rzx(_gate_p_0) _gate_q_0, _gate_q_1 {</span>
        <span class="c1">#         h _gate_q_1;</span>
        <span class="c1">#         cx _gate_q_0, _gate_q_1;</span>
        <span class="c1">#         rz(0.2) _gate_q_1;        // &lt;- note the concrete value.</span>
        <span class="c1">#         cx _gate_q_0, _gate_q_1;</span>
        <span class="c1">#         h _gate_q_1;</span>
        <span class="c1">#     }</span>
        <span class="c1"># This then means that multiple calls to the same gate with different parameters will be</span>
        <span class="c1"># incorrect.  By forcing all gates to be defined including their id, we generate a QASM3</span>
        <span class="c1"># program that does what was intended, even though the output QASM3 is silly.  See gh-7335.</span>
        <span class="k">if</span> <span class="n">instruction</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">Gate</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instruction</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">instruction</span>


<span class="c1"># A _Scope is the structure used in the builder to store the contexts and re-mappings of bits from</span>
<span class="c1"># the top-level scope where the bits were actually defined.  In the class, &#39;circuit&#39; is an instance</span>
<span class="c1"># of QuantumCircuit that defines this level, and &#39;bit_map&#39; is a mapping of &#39;Bit: Bit&#39;, where the</span>
<span class="c1"># keys are bits in the circuit in this scope, and the values are the Bit in the top-level scope in</span>
<span class="c1"># this context that this bit actually represents.  &#39;symbol_map&#39; is a bidirectional mapping of</span>
<span class="c1"># &#39;&lt;Terra object&gt;: Identifier&#39; and &#39;str: &lt;Terra object&gt;&#39;, where the string in the second map is the</span>
<span class="c1"># name of the identifier.  This is a cheap hack around actually implementing a proper symbol table.</span>
<span class="n">_Scope</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;_Scope&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;circuit&quot;</span><span class="p">,</span> <span class="s2">&quot;bit_map&quot;</span><span class="p">,</span> <span class="s2">&quot;symbol_map&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">QASM3Builder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;QASM3 builder constructs an AST from a QuantumCircuit.&quot;&quot;&quot;</span>

    <span class="n">builtins</span> <span class="o">=</span> <span class="p">(</span><span class="n">Barrier</span><span class="p">,</span> <span class="n">Measure</span><span class="p">,</span> <span class="n">Reset</span><span class="p">,</span> <span class="n">Delay</span><span class="p">,</span> <span class="n">BreakLoopOp</span><span class="p">,</span> <span class="n">ContinueLoopOp</span><span class="p">)</span>
    <span class="n">gate_parameter_prefix</span> <span class="o">=</span> <span class="s2">&quot;_gate_p&quot;</span>
    <span class="n">gate_qubit_prefix</span> <span class="o">=</span> <span class="s2">&quot;_gate_q&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">quantumcircuit</span><span class="p">,</span>
        <span class="n">includeslist</span><span class="p">,</span>
        <span class="n">basis_gates</span><span class="p">,</span>
        <span class="n">disable_constants</span><span class="p">,</span>
        <span class="n">alias_classical_registers</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># This is a stack of stacks; the outer stack is a list of &quot;outer&quot; look-up contexts, and the</span>
        <span class="c1"># inner stack is for scopes within these.  A &quot;outer&quot; look-up context in this sense means</span>
        <span class="c1"># the main program body or a gate/subroutine definition, whereas the scopes are for things</span>
        <span class="c1"># like the body of a ``for`` loop construct.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_context</span><span class="p">(</span><span class="n">quantumcircuit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includeslist</span> <span class="o">=</span> <span class="n">includeslist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gate_to_declare</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subroutine_to_declare</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opaque_to_declare</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_reg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_qubit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loose_clbit_index_lookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># An arbitrary counter to help with generation of unique ids for symbol names when there are</span>
        <span class="c1"># clashes (though we generally prefer to keep user names if possible).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_constants</span> <span class="o">=</span> <span class="n">disable_constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_classical_registers</span> <span class="o">=</span> <span class="n">alias_classical_registers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span> <span class="o">=</span> <span class="n">GlobalNamespace</span><span class="p">(</span><span class="n">includeslist</span><span class="p">,</span> <span class="n">basis_gates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gate_to_declare</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">gate</span><span class="p">)]</span> <span class="o">=</span> <span class="n">gate</span>

    <span class="k">def</span> <span class="nf">_register_subroutine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subroutine_to_declare</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">instruction</span><span class="p">)]</span> <span class="o">=</span> <span class="n">instruction</span>

    <span class="k">def</span> <span class="nf">_register_opaque</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instruction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_opaque_to_declare</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">instruction</span><span class="p">)]</span> <span class="o">=</span> <span class="n">instruction</span>

    <span class="k">def</span> <span class="nf">_register_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register a variable in the symbol table for the current scope, returning the name that</span>
<span class="sd">        should be used to refer to the variable.  The same name will be returned by subsequent calls</span>
<span class="sd">        to :meth:`_lookup_variable` within the same scope.</span>

<span class="sd">        If ``name`` is given explicitly, it must not already be defined in the scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note that the registration only checks for the existence of a variable that was declared</span>
        <span class="c1"># in the current scope, not just one that&#39;s available.  This is a rough implementation of</span>
        <span class="c1"># the shadowing proposal currently being drafted for OpenQASM 3, though we expect it to be</span>
        <span class="c1"># expanded and modified in the future (2022-03-07).</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">symbol_map</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_RESERVED_KEYWORDS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot reserve the keyword &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; as a variable name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;tried to reserve &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, but it is already used by &#39;</span><span class="si">{</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
            <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">table</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_RESERVED_KEYWORDS</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">__generated</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">table</span><span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="n">table</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">return</span> <span class="n">identifier</span>

    <span class="k">def</span> <span class="nf">_reserve_variable_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reserve a variable name in the current scope, raising a :class:`.QASM3ExporterError` if</span>
<span class="sd">        the name is already in use.</span>

<span class="sd">        This is useful for autogenerated names that the exporter itself reserves when dealing with</span>
<span class="sd">        objects that have no standard Terra object backing them, such as the declaration of all</span>
<span class="sd">        circuit qubits, so cannot be placed into the symbol table by the normal means.</span>

<span class="sd">        Returns the same identifier, for convenience in chaining.&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">symbol_map</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">string</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;tried to reserve &#39;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">string</span><span class="si">}</span><span class="s2">&#39;, but it is already used by &#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;internal object&gt;&quot;</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_lookup_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Lookup a Terra object within the current context, and return the name that should be used</span>
<span class="sd">        to represent it in OpenQASM 3 programmes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_context</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">scope</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scope</span><span class="o">.</span><span class="n">symbol_map</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&#39; is not defined in the current context&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a Header&quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
        <span class="n">includes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_includes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">includes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_program</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a Program&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoist_declarations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_scope</span><span class="p">(</span><span class="n">assert_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_header</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_global_statements</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">hoist_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Walks the definitions in gates/instructions to make a list of gates to declare.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">ControlFlowOp</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hoist_declarations</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtins</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">definition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_register_opaque</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hoist_declarations</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">Gate</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_register_gate</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_register_subroutine</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">global_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assert_</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the global circuit scope that is used as the basis of the full program.  If</span>
<span class="sd">        ``assert_=True``, then this raises :obj:`.QASM3ExporterError` if the current context is not</span>
<span class="sd">        the global one.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">assert_</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Defensive code to help catch logic errors.</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="sa">f</span><span class="s2">&quot;Not currently in the global context. Current contexts are: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">current_outermost_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the outermost scope for this context.  If building the main program, then this is</span>
<span class="sd">        the :obj:`.QuantumCircuit` instance that the full program is being built from.  If building</span>
<span class="sd">        a gate or subroutine definition, this is the body that defines the gate or subroutine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">current_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current circuit scope.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">current_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current context (list of scopes).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">qubits</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Qubit</span><span class="p">],</span> <span class="n">clbits</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Clbit</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Push a new scope (like a ``for`` or ``while`` loop body) onto the current context</span>
<span class="sd">        stack.&quot;&quot;&quot;</span>
        <span class="n">current_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">bit_map</span>
        <span class="n">qubits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">current_map</span><span class="p">[</span><span class="n">qubit</span><span class="p">]</span> <span class="k">for</span> <span class="n">qubit</span> <span class="ow">in</span> <span class="n">qubits</span><span class="p">)</span>
        <span class="n">clbits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">current_map</span><span class="p">[</span><span class="n">clbit</span><span class="p">]</span> <span class="k">for</span> <span class="n">clbit</span> <span class="ow">in</span> <span class="n">clbits</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">circuit</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="sa">f</span><span class="s2">&quot;Tried to push a scope whose circuit needs </span><span class="si">{</span><span class="n">circuit</span><span class="o">.</span><span class="n">num_qubits</span><span class="si">}</span><span class="s2"> qubits, but only&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; provided </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span><span class="si">}</span><span class="s2"> qubits to create the mapping.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">circuit</span><span class="o">.</span><span class="n">num_clbits</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clbits</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="sa">f</span><span class="s2">&quot;Tried to push a scope whose circuit needs </span><span class="si">{</span><span class="n">circuit</span><span class="o">.</span><span class="n">num_clbits</span><span class="si">}</span><span class="s2"> clbits, but only&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; provided </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clbits</span><span class="p">)</span><span class="si">}</span><span class="s2"> clbits to create the mapping.&quot;</span>
            <span class="p">)</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">qubits</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">clbits</span><span class="p">,</span> <span class="n">clbits</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_Scope</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">pop_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Scope</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pop the current scope (like a ``for`` or ``while`` loop body) off the current context</span>
<span class="sd">        stack.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="s2">&quot;Tried to pop a scope from the current context, but there are no current scopes.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">push_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outer_context</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Push a new context (like for a ``gate`` or ``def`` body) onto the stack.&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">bit</span><span class="p">:</span> <span class="n">bit</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">outer_context</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">outer_context</span><span class="o">.</span><span class="n">clbits</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">_Scope</span><span class="p">(</span><span class="n">outer_context</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="p">{})])</span>

    <span class="k">def</span> <span class="nf">pop_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pop the current context (like for a ``gate`` or ``def`` body) onto the stack.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="s2">&quot;Tried to pop the current context, but that is the global context.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
                <span class="s2">&quot;Tried to pop the current context while there are still&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> unclosed scopes.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_includes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a list of included files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeslist</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">build_global_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Statement</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        globalStatement</span>
<span class="sd">            : subroutineDefinition</span>
<span class="sd">            | kernelDeclaration</span>
<span class="sd">            | quantumGateDefinition</span>
<span class="sd">            | calibration</span>
<span class="sd">            | quantumDeclarationStatement  # build_quantumdeclaration</span>
<span class="sd">            | pragma</span>
<span class="sd">            ;</span>

<span class="sd">        statement</span>
<span class="sd">            : expressionStatement</span>
<span class="sd">            | assignmentStatement</span>
<span class="sd">            | classicalDeclarationStatement</span>
<span class="sd">            | branchingStatement</span>
<span class="sd">            | loopStatement</span>
<span class="sd">            | endStatement</span>
<span class="sd">            | aliasStatement</span>
<span class="sd">            | quantumStatement  # build_quantuminstruction</span>
<span class="sd">            ;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_definitions</span><span class="p">()</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_variable_declarations</span><span class="p">()</span>
        <span class="n">bit_declarations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_classical_declarations</span><span class="p">()</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_scope</span><span class="p">(</span><span class="n">assert_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">circuit</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;_layout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_qubit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">quantum_declarations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quantum_declarations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_quantum_declarations</span><span class="p">()</span>
        <span class="n">quantum_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_quantum_instructions</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_qubit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">statement</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">inputs</span><span class="p">,</span>
                <span class="n">outputs</span><span class="p">,</span>
                <span class="n">definitions</span><span class="p">,</span>
                <span class="n">variables</span><span class="p">,</span>
                <span class="n">bit_declarations</span><span class="p">,</span>
                <span class="n">quantum_declarations</span><span class="p">,</span>
                <span class="n">quantum_instructions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">source</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">build_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds all the definition.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opaque_to_declare</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_definition</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_opaque_definition</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subroutine_to_declare</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_definition</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_subroutine_definition</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gate_to_declare</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_definition</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_gate_definition</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">build_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Using a given definition builder, builds that definition.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instruction</span><span class="o">.</span><span class="n">_define_qasm3</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_reg</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="n">builder</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_reg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">definition</span>

    <span class="k">def</span> <span class="nf">build_opaque_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds an Opaque gate definition as a CalibrationDefinition&quot;&quot;&quot;</span>
        <span class="c1"># We can&#39;t do anything sensible with this yet, so it&#39;s better to loudly say that.</span>
        <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
            <span class="s2">&quot;Exporting opaque instructions with pulse-level calibrations is not yet supported by&quot;</span>
            <span class="s2">&quot; the OpenQASM 3 exporter. Received this instruction, which appears opaque:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_subroutine_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a SubroutineDefinition&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instruction</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="c1"># We don&#39;t yet have the type system to store the parameter types in a symbol table, and</span>
            <span class="c1"># we currently don&#39;t have the correct logic in place to handle parameters correctly in</span>
            <span class="c1"># the definition.</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
                <span class="s2">&quot;Exporting subroutines with parameters is not yet supported by the OpenQASM 3&quot;</span>
                <span class="s2">&quot; exporter. Received this instruction, which appears parameterized:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="p">[</span><span class="n">instruction</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_context</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">definition</span><span class="p">)</span>
        <span class="n">quantum_arguments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">QuantumArgument</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_qubit_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n_qubit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">n_qubit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">qubits</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">subroutine_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">SubroutineBlock</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_quantum_instructions</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">SubroutineDefinition</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">subroutine_body</span><span class="p">,</span> <span class="n">quantum_arguments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_gate_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a QuantumGateDefinition&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_context</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">definition</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_gate_signature</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_quantum_instructions</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumGateDefinition</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_gate_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a QuantumGateSignature&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="p">[</span><span class="n">gate</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">definition</span>
        <span class="c1"># Dummy parameters</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="n">parameters</span><span class="p">)):</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_parameter_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">param_name</span><span class="p">)))</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_register_variable</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">definition</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="n">quantum_arguments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_qubit_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n_qubit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">n_qubit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="n">qubits</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumGateSignature</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">quantum_arguments</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_variable_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds lists of the input, output and standard variables used in this program.&quot;&quot;&quot;</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">global_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_scope</span><span class="p">(</span><span class="n">assert_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">circuit</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">global_scope</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">parameter_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_variable</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
            <span class="n">declaration</span> <span class="o">=</span> <span class="n">_infer_variable_declaration</span><span class="p">(</span><span class="n">global_scope</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">declaration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">declaration</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">IODeclaration</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">declaration</span><span class="o">.</span><span class="n">modifier</span> <span class="ow">is</span> <span class="n">ast</span><span class="o">.</span><span class="n">IOModifier</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">declaration</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">declaration</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">declaration</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">variables</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_classical_register_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The base register name&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_all_clbits&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_classical_registers</span> <span class="k">else</span> <span class="s2">&quot;_loose_clbits&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>  <span class="c1"># TODO choose a different name if there is a name collision</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_quantum_register_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The base register name&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_all_qubits&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>  <span class="c1"># TODO choose a different name if there is a name collision</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">build_classical_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of AST nodes declaring all the classical bits and registers.</span>

<span class="sd">        The behaviour of this function depends on the setting ``alias_classical_registers``. If this</span>
<span class="sd">        is ``True``, then the output will be in the same form as the output of</span>
<span class="sd">        :meth:`.build_classical_declarations`, with the registers being aliases.  If ``False``, it</span>
<span class="sd">        will instead return a :obj:`.ast.ClassicalDeclaration` for each classical register, and one</span>
<span class="sd">        for the loose :obj:`.Clbit` instances, and will raise :obj:`QASM3ExporterError` if any</span>
<span class="sd">        registers overlap.</span>

<span class="sd">        This function populates the lookup table ``self._loose_clbit_index_lookup``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">circuit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_classical_registers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loose_clbit_index_lookup</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">bit</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">clbits</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">flat_declaration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_clbit_declaration</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">clbits</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_classical_register_name</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">flat_declaration</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_aliases</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">cregs</span><span class="p">)</span>
        <span class="n">loose_register_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">clbits</span><span class="p">):</span>
            <span class="n">found_bit</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">find_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_bit</span><span class="o">.</span><span class="n">registers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Clbit </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> is in multiple registers, but &#39;alias_classical_registers&#39; is&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; False. Registers and indices: </span><span class="si">{</span><span class="n">found_bit</span><span class="o">.</span><span class="n">registers</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_bit</span><span class="o">.</span><span class="n">registers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loose_clbit_index_lookup</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span> <span class="o">=</span> <span class="n">loose_register_size</span>
                <span class="n">loose_register_size</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">loose_register_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loose</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_clbit_declaration</span><span class="p">(</span>
                    <span class="n">loose_register_size</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_classical_register_name</span><span class="p">)),</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loose</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">loose</span> <span class="o">+</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_clbit_declaration</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">register</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_variable</span><span class="p">(</span><span class="n">register</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">register</span> <span class="ow">in</span> <span class="n">circuit</span><span class="o">.</span><span class="n">cregs</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">build_clbit_declaration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n_clbits</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassicalDeclaration</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a declaration of the :obj:`.Clbit`\\ s as a ``bit[n]``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassicalDeclaration</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">BitArrayType</span><span class="p">(</span><span class="n">n_clbits</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_quantum_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of AST nodes declaring all the qubits in the current scope, and all the</span>
<span class="sd">        alias declarations for these qubits.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">build_qubit_declarations</span><span class="p">()]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_aliases</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">qregs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_qubit_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a declaration of all the :obj:`.Qubit`\\ s in the current scope.&quot;&quot;&quot;</span>
        <span class="c1"># Base register</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumDeclaration</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_quantum_register_name</span><span class="p">)),</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">Designator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">)),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registers</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Register</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AliasStatement</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of alias declarations for the given registers.  The registers can be either</span>
<span class="sd">        classical or quantum.&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">register</span> <span class="ow">in</span> <span class="n">registers</span><span class="p">:</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Greedily consolidate runs of bits into ranges.  We don&#39;t bother trying to handle</span>
            <span class="c1"># steps; there&#39;s no need in generated code.  Even single bits are referenced as ranges</span>
            <span class="c1"># because the concatenation in an alias statement can only concatenate arraylike values.</span>
            <span class="n">start_index</span><span class="p">,</span> <span class="n">prev_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">register_identifier</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_quantum_register_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">register</span><span class="p">,</span> <span class="n">QuantumRegister</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_classical_register_name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">register</span><span class="p">:</span>
                <span class="n">cur_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
                <span class="k">if</span> <span class="n">start_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="n">cur_index</span>
                <span class="k">elif</span> <span class="n">cur_index</span> <span class="o">!=</span> <span class="n">prev_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">SubscriptedIdentifier</span><span class="p">(</span>
                            <span class="n">register_identifier</span><span class="p">,</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                                <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">start_index</span><span class="p">),</span>
                                <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">prev_index</span><span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">start_index</span> <span class="o">=</span> <span class="n">prev_index</span> <span class="o">=</span> <span class="n">cur_index</span>
                <span class="n">prev_index</span> <span class="o">=</span> <span class="n">cur_index</span>
            <span class="c1"># After the loop, if there were any bits at all, there&#39;s always one unemitted range.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">register</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">SubscriptedIdentifier</span><span class="p">(</span>
                        <span class="n">register_identifier</span><span class="p">,</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                            <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">start_index</span><span class="p">),</span>
                            <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">prev_index</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AliasStatement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_register_variable</span><span class="p">(</span><span class="n">register</span><span class="p">),</span> <span class="n">elements</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">build_quantum_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a list of call statements&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">Gate</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
                    <span class="n">eqcondition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_eqcondition</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>
                    <span class="n">operation_without_condition</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">operation_without_condition</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">true_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_program_block</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">instruction</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="n">operation_without_condition</span><span class="p">)]</span>
                    <span class="p">)</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">BranchingStatement</span><span class="p">(</span><span class="n">eqcondition</span><span class="p">,</span> <span class="n">true_body</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_gate_call</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">Barrier</span><span class="p">):</span>
                <span class="n">operands</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span>
                <span class="p">]</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">QuantumBarrier</span><span class="p">(</span><span class="n">operands</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">Measure</span><span class="p">):</span>
                <span class="n">measurement</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumMeasurement</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">clbits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">QuantumMeasurementAssignment</span><span class="p">(</span><span class="n">qubit</span><span class="p">,</span> <span class="n">measurement</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">Reset</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">QuantumReset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">operand</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">Delay</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_delay</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">ForLoopOp</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_for_loop</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">WhileLoopOp</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_while_loop</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">IfElseOp</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_if_statement</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">BreakLoopOp</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">BreakStatement</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">ContinueLoopOp</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">ContinueStatement</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_subroutine_call</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">build_if_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">CircuitInstruction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">BranchingStatement</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build an :obj:`.IfElseOp` into a :obj:`.ast.BranchingStatement`.&quot;&quot;&quot;</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_eqcondition</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>

        <span class="n">true_circuit</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">true_circuit</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">clbits</span><span class="p">)</span>
        <span class="n">true_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_program_block</span><span class="p">(</span><span class="n">true_circuit</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">BranchingStatement</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">true_body</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">false_circuit</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">false_circuit</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">clbits</span><span class="p">)</span>
        <span class="n">false_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_program_block</span><span class="p">(</span><span class="n">false_circuit</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">BranchingStatement</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">true_body</span><span class="p">,</span> <span class="n">false_body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_while_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">CircuitInstruction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">WhileLoopStatement</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build a :obj:`.WhileLoopOp` into a :obj:`.ast.WhileLoopStatement`.&quot;&quot;&quot;</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_eqcondition</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>
        <span class="n">loop_circuit</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">loop_circuit</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">clbits</span><span class="p">)</span>
        <span class="n">loop_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_program_block</span><span class="p">(</span><span class="n">loop_circuit</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">WhileLoopStatement</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">loop_body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_for_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">CircuitInstruction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">ForLoopStatement</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build a :obj:`.ForLoopOp` into a :obj:`.ast.ForLoopStatement`.&quot;&quot;&quot;</span>
        <span class="n">indexset</span><span class="p">,</span> <span class="n">loop_parameter</span><span class="p">,</span> <span class="n">loop_circuit</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">loop_circuit</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">clbits</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_parameter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The loop parameter is implicitly declared by the ``for`` loop (see also</span>
            <span class="c1"># _infer_parameter_declaration), so it doesn&#39;t matter that we haven&#39;t declared this.</span>
            <span class="n">loop_parameter_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserve_variable_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loop_parameter_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_variable</span><span class="p">(</span><span class="n">loop_parameter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indexset</span><span class="p">,</span> <span class="nb">range</span><span class="p">):</span>
            <span class="c1"># QASM 3 uses inclusive ranges on both ends, unlike Python.</span>
            <span class="n">indexset_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">indexset</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">indexset</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">indexset</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="k">if</span> <span class="n">indexset</span><span class="o">.</span><span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">indexset_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">IndexSet</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">indexset</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">QASM3ExporterError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
                    <span class="s2">&quot;The values in QASM 3 &#39;for&#39; loops must all be integers, but received&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">indexset</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
        <span class="n">body_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_program_block</span><span class="p">(</span><span class="n">loop_circuit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">ForLoopStatement</span><span class="p">(</span><span class="n">indexset_ast</span><span class="p">,</span> <span class="n">loop_parameter_ast</span><span class="p">,</span> <span class="n">body_ast</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">CircuitInstruction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumDelay</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build a built-in delay statement.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instruction</span><span class="o">.</span><span class="n">clbits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found a delay instruction acting on classical bits: </span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">duration_value</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationLiteral</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">duration_value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationUnit</span><span class="o">.</span><span class="n">NANOSECOND</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ns&quot;</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationUnit</span><span class="o">.</span><span class="n">NANOSECOND</span><span class="p">,</span>
                <span class="s2">&quot;us&quot;</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationUnit</span><span class="o">.</span><span class="n">MICROSECOND</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationUnit</span><span class="o">.</span><span class="n">MILLISECOND</span><span class="p">,</span>
                <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationUnit</span><span class="o">.</span><span class="n">SECOND</span><span class="p">,</span>
                <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationUnit</span><span class="o">.</span><span class="n">SAMPLE</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">DurationLiteral</span><span class="p">(</span><span class="n">duration_value</span><span class="p">,</span> <span class="n">unit_map</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumDelay</span><span class="p">(</span>
            <span class="n">duration</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span> <span class="k">for</span> <span class="n">qubit</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Integer</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build an integer literal, raising a :obj:`.QASM3ExporterError` if the input is not</span>
<span class="sd">        actually an</span>
<span class="sd">        integer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="c1"># This is meant to be purely defensive, in case a non-integer slips into the logic</span>
            <span class="c1"># somewhere, but no valid Terra object should trigger this.</span>
            <span class="k">raise</span> <span class="n">QASM3ExporterError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; is not an integer&quot;</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">build_program_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a ProgramBlock&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">ProgramBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_quantum_instructions</span><span class="p">(</span><span class="n">instructions</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">build_eqcondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Classical Conditional condition from a instruction.condition&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Clbit</span><span class="p">):</span>
            <span class="n">condition_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">condition_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_variable</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">ComparisonExpression</span><span class="p">(</span>
            <span class="n">condition_on</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">EqualsOperator</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rebind_scoped_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the input is a :class:`.ParameterExpression`, rebind any internal</span>
<span class="sd">        :class:`.Parameter`\\ s so that their names match their names in the scope.  Other inputs</span>
<span class="sd">        are returned unchanged.&quot;&quot;&quot;</span>
        <span class="c1"># This is a little hacky, but the entirety of the Expression handling is essentially</span>
        <span class="c1"># missing, pending a new system in Terra to replace it (2022-03-07).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">ParameterExpression</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">expression</span>
        <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lookup_variable</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">parameters</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_gate_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">CircuitInstruction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a QuantumGateCall&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">standard_gates</span><span class="o">.</span><span class="n">UGate</span><span class="p">):</span>
            <span class="n">gate_name</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gate_name</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="p">[</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">])</span>
        <span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span> <span class="k">for</span> <span class="n">qubit</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_constants</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rebind_scoped_parameters</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">params</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">pi_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rebind_scoped_parameters</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;qasm&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">params</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">QuantumGateCall</span><span class="p">(</span><span class="n">gate_name</span><span class="p">,</span> <span class="n">qubits</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_subroutine_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="n">CircuitInstruction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds a SubroutineCall&quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_namespace</span><span class="p">[</span><span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="p">])</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
        <span class="c1"># TODO: qubits should go inside the brackets of subroutine calls, but neither Terra nor the</span>
        <span class="c1"># AST here really support the calls, so there&#39;s no sensible way of writing it yet.</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">build_single_bit_reference</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">qubits</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">SubroutineCall</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">expressions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_single_bit_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bit</span><span class="p">:</span> <span class="n">Bit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get an identifier node that refers to one particular bit.&quot;&quot;&quot;</span>
        <span class="n">found_bit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_qubit</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">PhysicalQubitIdentifier</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">found_bit</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flat_reg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_qubit_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">found_bit</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found_bit</span><span class="o">.</span><span class="n">registers</span><span class="p">:</span>
            <span class="c1"># We preferentially return a reference via a register in the hope that this is what the</span>
            <span class="c1"># user is used to seeing as well.</span>
            <span class="n">register</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">found_bit</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">SubscriptedIdentifier</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_variable</span><span class="p">(</span><span class="n">register</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise reference via the list of all qubits, or the list of loose clbits.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">Qubit</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">SubscriptedIdentifier</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_quantum_register_name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="n">found_bit</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">SubscriptedIdentifier</span><span class="p">(</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_classical_register_name</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_integer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loose_clbit_index_lookup</span><span class="p">[</span><span class="n">bit</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bit</span><span class="p">:</span> <span class="n">Bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up the bit using :meth:`.QuantumCircuit.find_bit` in the current outermost scope.&quot;&quot;&quot;</span>
        <span class="c1"># This is a hacky work-around for now. Really this should be a proper symbol-table lookup,</span>
        <span class="c1"># but with us expecting to put in a whole new AST for Terra 0.20, this should be sufficient</span>
        <span class="c1"># for the use-cases we support.  (Jake, 2021-11-22.)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_context</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ancestor_bit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">bit_map</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_outermost_scope</span><span class="p">()</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">find_bit</span><span class="p">(</span><span class="n">ancestor_bit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_scope</span><span class="p">()</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">find_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_infer_variable_declaration</span><span class="p">(</span>
    <span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">parameter</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Identifier</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">ClassicalDeclaration</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Attempt to infer what type a parameter should be declared as to work with a circuit.</span>

<span class="sd">    This is very simplistic; it assumes all parameters are real numbers that need to be input to the</span>
<span class="sd">    program, unless one is used as a loop variable, in which case it shouldn&#39;t be declared at all,</span>
<span class="sd">    because the ``for`` loop declares it implicitly (per the Qiskit/QSS reading of the OpenQASM</span>
<span class="sd">    spec at Qiskit/openqasm@8ee55ec).</span>

<span class="sd">    .. note::</span>

<span class="sd">        This is a hack around not having a proper type system implemented in Terra, and really this</span>
<span class="sd">        whole function should be removed in favour of proper symbol-table building and lookups.</span>
<span class="sd">        This function is purely to try and hack the parameters for ``for`` loops into the exporter</span>
<span class="sd">        for now.</span>

<span class="sd">    Args:</span>
<span class="sd">        circuit: The global-scope circuit, which is the base of the exported program.</span>
<span class="sd">        parameter: The parameter to infer the type of.</span>
<span class="sd">        parameter_name: The name of the parameter to use in the declaration.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A suitable :obj:`.ast.ClassicalDeclaration` node, or, if the parameter should *not* be</span>
<span class="sd">        declared, then ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">is_loop_variable</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recurse into the instructions a parameter is used in, checking at every level if it is</span>
<span class="sd">        used as the loop variable of a ``for`` loop.&quot;&quot;&quot;</span>
        <span class="c1"># This private access is hacky, and shouldn&#39;t need to happen; the type of a parameter</span>
        <span class="c1"># _should_ be an intrinsic part of the parameter, or somewhere publicly accessible, but</span>
        <span class="c1"># Terra doesn&#39;t have those concepts yet.  We can only try and guess at the type by looking</span>
        <span class="c1"># at all the places it&#39;s used in the circuit.</span>
        <span class="k">for</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">circuit</span><span class="o">.</span><span class="n">_parameter_table</span><span class="p">[</span><span class="n">parameter</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">ForLoopOp</span><span class="p">):</span>
                <span class="c1"># The parameters of ForLoopOp are (indexset, loop_parameter, body).</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">ControlFlowOp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_loop_variable</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">parameter</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">is_loop_variable</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Arbitrary choice of double-precision float for all other parameters, but it&#39;s what we actually</span>
    <span class="c1"># expect people to be binding to their Parameters right now.</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">IODeclaration</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">IOModifier</span><span class="o">.</span><span class="n">INPUT</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FloatType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">)</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Qiskit Development Team.
      Zuletzt aktualisiert am 2022/07/13.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/thebelab-helper.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
         <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
         <script src="../../../_static/design-tabs.js"></script>
         <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <div>
    <br>
  </div>

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://qiskit.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="../../../getting_started.html">Getting Started</a>
          </li>
          <li>
            <a href="../../../tutorials.html">Tutorials</a>
          </li>
          <li>
            <a href="https://qiskit.org/documentation/partners/">Partners</a>
          </li>
          <br>
          <li class="resources-mobile-menu-title">
            Applications
          </li>
          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://qiskit.org/documentation/machine-learning/">Machine learning</a>
            </li>

            <li>
              <a href="https://qiskit.org/documentation/nature/">Nature</a>
            </li>

            <li>
              <a href="https://qiskit.org/documentation/finance/">Finance</a>
            </li>

            <li>
              <a href="https://qiskit.org/documentation/optimization/">Optimization</a>
            </li>
          </ul>
          <br>
          <li>
            <a href="https://qiskit.org/documentation/experiments/">Experiments</a>
          </li>
          <br>
          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://qiskit.slack.com">Slack support</a>
            </li>
          </ul>
          <br>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>